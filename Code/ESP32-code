#include <WiFi.h>
#include <WiFiMulti.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <time.h>

// Dane do Telegrama
#define BOT_TOKEN "your_telegram_bot_token"
#define CHAT_ID "<your_chatID_on_telegram"

WiFiMulti wifiMulti;
WiFiClientSecure secured_client;
UniversalTelegramBot bot(BOT_TOKEN, secured_client);

const int ledPin = 2;
unsigned long lastTimeBotRan;

void sendStartupMessage() {
  String message = "ðŸ”Œ ESP32 uruchomione!\n";
  message += "ðŸ“¶ SieÄ‡: " + WiFi.SSID() + "\n";
  message += "ðŸŒ IP: " + WiFi.localIP().toString() + "\n";
  message += "ðŸ“¡ RSSI: " + String(WiFi.RSSI()) + " dBm\n";
  bot.sendMessage(CHAT_ID, message, "");
}

String getUptime() {
  long seconds = millis() / 1000;
  int days = seconds / 86400;
  seconds %= 86400;
  int hours = seconds / 3600;
  seconds %= 3600;
  int minutes = seconds / 60;
  seconds %= 60;
  return String(days) + "d " + hours + "h " + minutes + "m " + seconds + "s";
}

void setupTime() {
  configTime(3600, 3600, "pool.ntp.org", "time.nist.gov");
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    Serial.println("âŒ Nie udaÅ‚o siÄ™ pobraÄ‡ czasu z NTP");
  } else {
    Serial.println("â° Czas ustawiony z NTP");
  }
}

void setup() {
  Serial.begin(115200);
  pinMode(ledPin, OUTPUT);
  digitalWrite(ledPin, LOW);

  secured_client.setInsecure();

  wifiMulti.addAP("wifi1", "passwordforwifi1");
  wifiMulti.addAP("wifi2", "passwordforwifi2");
  wifiMulti.addAP("wifi3", "passwordforwifi3");
  wifiMulti.addAP("wifi4", "passwordforwifi4");
  wifiMulti.addAP("wifi5", "passwordforwifi5");
  wifiMulti.addAP("wifi6", "passwordforwifi6");

  Serial.println("ÅÄ…czenie z WiFi...");
  while (wifiMulti.run() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nâœ… PoÅ‚Ä…czono z WiFi!");
  Serial.print("IP: ");
  Serial.println(WiFi.localIP());

  setupTime();
  sendStartupMessage();
  lastTimeBotRan = millis();
}

void loop() {
  if (millis() - lastTimeBotRan > 1000) {
    int numNewMessages = bot.getUpdates(bot.last_message_received + 1);

    while (numNewMessages) {
      for (int i = 0; i < numNewMessages; i++) {
        String text = bot.messages[i].text;
        String from = bot.messages[i].from_name;

        Serial.print("Komenda od ");
        Serial.print(from);
        Serial.print(": ");
        Serial.println(text);

        if (text == "/zapal") {
          digitalWrite(ledPin, HIGH);
          bot.sendMessage(CHAT_ID, "ðŸ’¡ Dioda wÅ‚Ä…czona!", "");
        } else if (text == "/zgas") {
          digitalWrite(ledPin, LOW);
          bot.sendMessage(CHAT_ID, "ðŸ’¡ Dioda wyÅ‚Ä…czona!", "");
        } else if (text == "/status") {
          bool state = digitalRead(ledPin);
          bot.sendMessage(CHAT_ID, state ? "ðŸ”† Dioda JEST WÅÄ„CZONA" : "ðŸ”… Dioda jest wyÅ‚Ä…czona", "");
        } else if (text == "/uptime") {
          bot.sendMessage(CHAT_ID, "â±ï¸ Czas dziaÅ‚ania: " + getUptime(), "");
        } else if (text == "/disconnect") {
          WiFi.disconnect();
          bot.sendMessage(CHAT_ID, "ðŸ“´ RozÅ‚Ä…czono z Wi-Fi", "");
        } else if (text == "/rebootwifi") {
          WiFi.disconnect();
          delay(1000);
          WiFi.reconnect();
          bot.sendMessage(CHAT_ID, "â™»ï¸ Restart poÅ‚Ä…czenia Wi-Fi", "");
        } else if (text == "/listaps") {
          String msg = "ðŸ“¡ Zapisane sieci:\n";
          for (int i = 0; i < wifiMulti.run(); i++) {
            msg += "- " + String(i + 1) + "\n";
          }
          bot.sendMessage(CHAT_ID, msg, "");
        } else if (text == "/mac") {
          bot.sendMessage(CHAT_ID, "ðŸ” MAC: " + WiFi.macAddress(), "");
        //} else if (text == "/restart") {
          //bot.sendMessage(CHAT_ID, "ðŸ” Restart ESP32...", "");
          //delay(1000);
          //ESP.restart();
        } else if (text == "/czas") {
          struct tm timeinfo;
          if (getLocalTime(&timeinfo)) {
            char buffer[64];
            strftime(buffer, sizeof(buffer), "â° Czas: %d.%m.%Y %H:%M:%S", &timeinfo);
            bot.sendMessage(CHAT_ID, buffer, "");
          } else {
            bot.sendMessage(CHAT_ID, "âŒ BÅ‚Ä…d pobierania czasu", "");
          }
        } else if (text == "/wifiinfo") {
          String info = "ðŸ“¶ SieÄ‡: " + WiFi.SSID() + "\n";
          info += "ðŸŒ IP: " + WiFi.localIP().toString() + "\n";
          info += "ðŸ“¡ RSSI: " + String(WiFi.RSSI()) + " dBm\n";
          bot.sendMessage(CHAT_ID, info, "");
        } else if (text == "/help") {
          String helpMessage = "ðŸ“– DostÄ™pne komendy:\n";
          helpMessage += "/zapal - WÅ‚Ä…cz diodÄ™ LED\n";
          helpMessage += "/zgas - WyÅ‚Ä…cz diodÄ™ LED\n";
          helpMessage += "/status - Stan diody LED\n";
          helpMessage += "/czas - Aktualny czas (NTP)\n";
          helpMessage += "/uptime - Czas dziaÅ‚ania ESP32\n";
          helpMessage += "/disconnect - RozÅ‚Ä…cz z Wi-Fi\n";
          helpMessage += "/rebootwifi - PoÅ‚Ä…cz ponownie z Wi-Fi\n";
          helpMessage += "/listaps - Lista zapisanych sieci\n";
          helpMessage += "/mac - PokaÅ¼ adres MAC\n";
          helpMessage += "/restart - Zrestartuj ESP32\n";
          helpMessage += "/wifiinfo - SzczegÃ³Å‚y poÅ‚Ä…czenia Wi-Fi\n";
          helpMessage += "/help - WyÅ›wietl tÄ™ pomoc";
          bot.sendMessage(CHAT_ID, helpMessage, "");
        } else {
          bot.sendMessage(CHAT_ID, "â“ Nieznana komenda. Wpisz /help", "");
        }
      }

      numNewMessages = bot.getUpdates(bot.last_message_received + 1);
    }

    lastTimeBotRan = millis();
  }
}

